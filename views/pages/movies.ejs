<!DOCTYPE html>
<html>
<head>
    <title>Mo's Movies</title>
    <% include ../partials/header.ejs %>

    <script type="text/javascript" src="https://fb.me/react-0.13.3.js"></script>
    <script type="text/javascript" src="https://fb.me/JSXTransformer-0.13.3.js"></script>
</head>

<body>
    <div id="c"></div>
    <script type="text/jsx">
        function isNumber(value) {
            return typeof value === "number" && 
               isFinite(value) && 
               Math.floor(value) === value;
        }

        var MovieRow = React.createClass({
            handleClickRating1: function(e) {
                this.handleClickRating(e, 1);
            },
            handleClickRating2: function(e) {
                this.handleClickRating(e, 2);
            },
            handleClickRating3: function(e) {
                this.handleClickRating(e, 3);
            },
            handleClickRating4: function(e) {
                this.handleClickRating(e, 4);
            },
            handleClickRating5: function(e) {
                this.handleClickRating(e, 5);
            },
            handleClickRating: function(e, value) {
                e.preventDefault();

                $.ajax({
                    url: '/movies/' + this.props.movie.movies_id + '.json',
                    dataType: 'json',
                    type: 'PATCH',
                    data: {
                        myRating: value
                    },
                    success: function(data) {
                        if (this.props.onRatingSaved) {
                            this.props.onRatingSaved(data, this.props.movie);
                        }
                        if (this.props.onMovieChanged) {
                            this.props.onMovieChanged(this.props.movie);
                        }
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.log(status, err);
                    }.bind(this)
                });

            },
            handleClickRemove: function(e) {
                e.preventDefault();
                var myRating = this.props.movie.myRating;

                if (!myRating) {
                    return;
                }

                $.ajax({
                    url: '/movie-ratings/' + myRating.movie_ratings_id + '.json',
                    type: 'DELETE',
                    success: function(data) {
                        if (this.props.onRatingRemoved) {
                            this.props.onRatingRemoved(this.props.movie);
                        }
                        if (this.props.onMovieChanged) {
                            this.props.onMovieChanged(this.props.movie);
                        }
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.log(status, err);
                    }.bind(this)
                });
            },
            render: function() {
                var rating = (this.props.movie.rating ? this.props.movie.rating : -1);
                var myRating = (this.props.movie.myRating ? this.props.movie.myRating.value : -1);

                function buildStarClassNamesArray(rating) {
                    var index = -1,
                        value = -1;
                        starClassNames = [];
                    for (index = 0; index < 5; index++) {
                        value = index + 1;
                        if (rating >= value) {
                            starClassNames.push('fa-star');
                        } else {
                            starClassNames.push('fa-star-o');
                        }
                    }
                    return starClassNames;
                }
                var ratingStarClassNames = buildStarClassNamesArray(rating);
                var myRatingStarClassNames = buildStarClassNamesArray(myRating);
                var removeRatingEl;

                // build the element for the remove rating only when a rating has been added
                if (this.props.movie.myRating) {
                    removeRatingEl = (
                        <a className="ratingRemoveButton" onClick={this.handleClickRemove} alt="Remove" style={{'paddingLeft': '10px'}}>
                            <span style={{display: 'none'}}>Remove</span>
                            <i className={'fa fa-ban'}></i>
                        </a>
                    );
                } else {
                    removeRatingEl = null;
                }

                return (
                    <tr className="movieRow">
                        <td>{this.props.movie.title}</td>
                        <td className="ratingCell">
                            <i className={'fa ' + ratingStarClassNames[0]}></i>
                            <i className={'fa ' + ratingStarClassNames[1]}></i>
                            <i className={'fa ' + ratingStarClassNames[2]}></i>
                            <i className={'fa ' + ratingStarClassNames[3]}></i>
                            <i className={'fa ' + ratingStarClassNames[4]}></i>
                        </td>
                        <td className="myRatingCell">
                            <a onClick={this.handleClickRating1}>
                                <span style={{display: 'none'}}>1</span>
                                <i className={'fa ' + myRatingStarClassNames[0]}></i>
                            </a>
                            <a onClick={this.handleClickRating2}>
                                <span style={{display: 'none'}}>2</span>
                                <i className={'fa ' + myRatingStarClassNames[1]}></i>
                            </a>
                            <a onClick={this.handleClickRating3}>
                                <span style={{display: 'none'}}>3</span>
                                <i className={'fa ' + myRatingStarClassNames[2]}></i>
                            </a>
                            <a onClick={this.handleClickRating4}>
                                <span style={{display: 'none'}}>4</span>
                                <i className={'fa ' + myRatingStarClassNames[3]}></i>
                            </a>
                            <a onClick={this.handleClickRating5}>
                                <span style={{display: 'none'}}>5</span>
                                <i className={'fa ' + myRatingStarClassNames[4]}></i>
                            </a>
                            {removeRatingEl}
                        </td>
                    </tr>
                );
            }
        });

        var MovieList = React.createClass({
            handleMovieChanged: function(movie) {
                if (this.props.onMovieChanged) {
                    this.props.onMovieChanged(movie);
                }
            },
            render: function() {
                var rows = this.props.movies.map(function(movie) {
                    return (
                        <MovieRow key={movie.movies_id} movie={movie} onMovieChanged={this.handleMovieChanged} />
                    );
                }.bind(this));
                return (
                    <table className="table table-striped">
                        <thead>
                            <th>Title</th>
                            <th>Rating</th>
                            <th>My Rating</th>
                        </thead>
                        <tbody>
                            {rows}
                        </tbody>
                    </table>
                );
            }
        });

        var ErrorMessageItem = React.createClass({
            render: function() {
                return (
                    <div>{this.props.errorMessage}</div>
                );
            }
        });

        var ErrorMessages = React.createClass({
            render: function() {
                if (this.props.errorMessages && this.props.errorMessages.length > 0) {
                    var items = this.props.errorMessages.map(function(errorMessage, i) {
                        return (
                            <ErrorMessageItem key={i} errorMessage={errorMessage} />
                        );
                    });
                    return (
                        <div>
                            {items}
                        </div>
                    );
                } else {
                    return null;
                }
            }
        });

        var AddMovieForm = React.createClass({
            getInitialState: function() {
                return {
                    errorMessages: []
                };
            },
            handleSubmit: function(e) {
                e.preventDefault();

                var title = React.findDOMNode(this.refs.title).value.trim(),
                    ratingAsString = React.findDOMNode(this.refs.rating).value.trim(),
                    rating;
                var newMovie;

                // TODO add validation for title and rating
                var validationErrorMessages = [];
                if (!title) {
                    validationErrorMessages.push('Title is a required field');
                }
                if (title && title.length > 100) {
                    validationErrorMessages.push('Title must be less than 100 characters');
                }
                if (ratingAsString) {
                    if (!isNumber(parseFloat(ratingAsString))) {
                        validationErrorMessages.push('Rating must be a positive integer value');
                    } else {
                        rating = parseFloat(ratingAsString);
                        if (rating % 1 == 0 && rating > 0) {
                            rating = parseInt(ratingAsString, 10);
                        } else {
                            validationErrorMessages.push('Rating must be a positive integer value');
                        }
                    }
                }
                this.setState({
                    errorMessages: validationErrorMessages
                });
                if (validationErrorMessages.length > 0) {
                    return;
                }

                newMovie = {
                    title: title,
                    rating: rating
                };

                $.ajax({
                    url: '/movies.json',
                    dataType: 'json',
                    type: 'POST',
                    data: newMovie,
                    success: function(data) {
                        if (this.props.onMovieSaved) {
                            this.props.onMovieSaved(data);
                        }

                        // clear the form fields
                        React.findDOMNode(this.refs.title).value = '';
                        React.findDOMNode(this.refs.rating).value = '';
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.log(status, err);
                    }.bind(this)
                });

                return;
            },
            render: function() {
                return (
                    <div>
                        <ErrorMessages errorMessages={this.state.errorMessages} />
                        <form className="form-horizontal" onSubmit={this.handleSubmit}>
                            <div className="form-group">
                                <label htmlFor="title" className="col-sm-2 control-label">Title</label>
                                <div className="col-sm-10">
                                    <input type="text" className="form-control" id="title" name="title" ref="title" />
                                </div>
                            </div>
                            <div className="form-group">
                                <label htmlFor="rating" className="col-sm-2 control-label">Rating</label>
                                <div className="col-sm-10">
                                    <input type="text" className="form-control" id="rating" name="rating" ref="rating" />
                                </div>
                            </div>
                            <div className="form-group">
                                <div className="col-sm-offset-2 col-sm-10">
                                    <button type="submit" className="btn btn-default">Add</button>
                                </div>
                            </div>
                        </form>
                    </div>
                );
            }
        });

        var MoviesPageView = React.createClass({
            handleMovieSaved: function(data) {
                this.loadMoviesFromServer();
            },
            handleMovieChanged: function(movie) {
                console.log('Movie changed; updating list');
                this.loadMoviesFromServer();
            },
            getInitialState: function() {
                return {
                    movies: []
                };
            },
            componentDidMount: function() {
                this.loadMoviesFromServer();
            },
            render: function() {
                return (
                    <div>
                        <AddMovieForm onMovieSaved={this.handleMovieSaved} />
                        <MovieList movies={this.state.movies} onMovieChanged={this.handleMovieChanged} />
                    </div>
                );
            },
            loadMoviesFromServer: function() {
                $.ajax({
                    url: '/movies.json',
                    dataType: 'json',
                    cache: false,
                    success: function(data) {
                        this.setState({
                            movies: data.results
                        });
                    }.bind(this),
                    error: function(xhr, status, err) {
                        console.err(status, err);
                    }.bind(this)
                });
            }
        });

        React.render(
            <div className="container">
                <h1>Mo's Movies</h1>
                <MoviesPageView />
            </div>,
        document.getElementById('c')
        );
    </script>
</body>
</html>